import{fromElements as z,parse as W,toElement as X,toRange as V}from"./epubcfi-CHOUELlF.js";const w={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},I={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},T={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},G={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},J={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},U=i=>i.toLowerCase().replace(/[-:](.)/g,(t,e)=>e.toUpperCase()),K=i=>i?i.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",Q=(i,t,e)=>e?s=>s.getAttribute(i)?.split(/\s/)?.includes(t):typeof t=="function"?s=>t(s.getAttribute(i)):s=>s.getAttribute(i)===t,C=(...i)=>t=>t?Object.fromEntries(i.map(e=>[U(e),t.getAttribute(e)])):null,L=i=>K(i?.textContent),M=(i,t)=>{const e=i.lookupNamespaceURI(null)===t||i.lookupPrefix(t),s=e?(r,c)=>o=>o.namespaceURI===t&&o.localName===c:(r,c)=>o=>o.localName===c;return{$:(r,c)=>[...r.children].find(s(r,c)),$$:(r,c)=>[...r.children].filter(s(r,c)),$$$:e?(r,c)=>[...r.getElementsByTagNameNS(t,c)]:(r,c)=>[...r.getElementsByTagName(c)]}},N=(i,t)=>{try{if(t.includes(":"))return new URL(i,t);const e="https://invalid.invalid/",s=new URL(i,e+t);return s.search="",decodeURI(s.href.replace(e,""))}catch(e){return console.warn(e),i}},_=i=>/^(?!blob)\w+:/i.test(i),Y=(i,t)=>{if(!i)return t;const e=i.replace(/\/$/,"").split("/"),s=t.replace(/\/$/,"").split("/"),r=(e.length>s.length?e:s).findIndex((c,o)=>e[o]!==s[o]);return r<0?"":Array(e.length-r).fill("..").concat(s.slice(r)).join("/")},Z=i=>i.slice(0,i.lastIndexOf("/")+1),k=async(i,t,e)=>{const s=[];i.replace(t,(...c)=>(s.push(c),null));const r=[];for(const c of s)r.push(await e(...c));return i.replace(t,()=>r.shift())},tt=i=>i.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),O=i=>{for(const[e,s]of Object.entries(i))s==null?delete i[e]:Array.isArray(s)?(i[e]=s.filter(r=>r).map(r=>typeof r=="object"&&!Array.isArray(r)?O(r):r),i[e].length?i[e].length===1&&(i[e]=i[e][0]):delete i[e]):typeof s=="object"&&(i[e]=O(s),Object.keys(s).length||delete i[e]);const t=Object.keys(i);return t.length===1&&t[0]==="name"?i[t[0]]:i},et=i=>{const t=new Map(Object.entries(T)),e=i.documentElement.getAttributeNS(w.EPUB,"prefix")||i.documentElement.getAttribute("prefix");if(e)for(const[,s,r]of e.matchAll(/(.+): +(.+)[ \t\r\n]*/g))t.set(s,r);return t},D=(i,t)=>{if(!i)return null;const[e,s]=i.split(":"),r=s?e:null,c=s||e,o=t.get(r);return o?o+c:null},st=i=>{const{$:t}=M(i,w.OPF),e=t(i.documentElement,"metadata"),s=Object.groupBy(e.children,n=>n.namespaceURI===w.DC?"dc":n.namespaceURI===w.OPF&&n.localName==="meta"?n.hasAttribute("name")?"legacyMeta":"meta":""),r=e.getAttribute("xml:lang")??i.documentElement.getAttribute("xml:lang")??"und",c=et(i),o=n=>{const f=n.getAttribute("property"),b=n.getAttribute("scheme");return{property:D(f,c)??f,scheme:D(b,c)??b,lang:n.getAttribute("xml:lang"),value:L(n),props:a(n),attrs:Object.fromEntries(Array.from(n.attributes).filter(v=>v.namespaceURI===w.OPF).map(v=>[v.localName,v.value]))}},h=Map.groupBy(s.meta??[],n=>n.getAttribute("refines")),a=n=>{const f=h.get(n?"#"+n.getAttribute("id"):null);return f?Object.groupBy(f.map(o),b=>b.property):null},l=Object.fromEntries(Object.entries(Object.groupBy(s.dc,n=>n.localName)).map(([n,f])=>[n,f.map(o)])),d=a()??{},p=Object.fromEntries(s.legacyMeta?.map(n=>[n.getAttribute("name"),n.getAttribute("content")])??[]),u=n=>n?.[0]?.value,g=(n,f)=>u(n?.props?.[f]),m=n=>{if(!n)return null;const f=n.props?.["alternate-script"]??[],b=n.attrs["alt-rep"];if(!f.length&&(!n.lang||n.lang===r)&&!b)return n.value;const v={[n.lang??r]:n.value};b&&(v[n.attrs["alt-rep-lang"]]=b);for(const F of f)v[F.lang]??=F.value;return v},y=n=>n?{name:m(n),sortAs:m(n.props?.["file-as"]?.[0])??n.attrs["file-as"],role:n.props?.role?.filter(f=>f.scheme===T.marc+"relators")?.map(f=>f.value)??[n.attrs.role],code:g(n,"term")??n.attrs.term,scheme:g(n,"authority")??n.attrs.authority}:null,A=n=>({name:m(n),position:u(n.props?.["group-position"])}),S=n=>{const{value:f}=n;if(/^urn:/i.test(f))return f;if(/^doi:/i.test(f))return`urn:${f}`;const b=n.props?.["identifier-type"];if(!b){const v=n.attrs.scheme;return v?/^(doi|isbn|uuid)$/i.test(v)?`urn:${v}:${f}`:{scheme:v,value:f}:f}if(b.scheme===T.onix+"codelist5"){const v=J[b.value];if(v)return`urn:${v}:${f}`}return f},$=Object.groupBy(d["belongs-to-collection"]??[],n=>g(n,"collection-type")==="series"?"series":"collection"),R=l.title?.find(n=>g(n,"title-type")==="main")??l.title?.[0],E={identifier:q(i),title:m(R),sortAs:m(R?.props?.["file-as"]?.[0])??R?.attrs?.["file-as"]??p?.["calibre:title_sort"],subtitle:l.title?.find(n=>g(n,"title-type")==="subtitle")?.value,language:l.language?.map(n=>n.value),description:u(l.description),publisher:y(l.publisher?.[0]),published:l.date?.find(n=>n.attrs.event==="publication")?.value??u(l.date),modified:u(d[T.dcterms+"modified"])??l.date?.find(n=>n.attrs.event==="modification")?.value,subject:l.subject?.map(y),belongsTo:{collection:$.collection?.map(A),series:$.series?.map(A)??p?.["calibre:series"]?{name:p?.["calibre:series"],position:parseFloat(p?.["calibre:series_index"])}:null},altIdentifier:l.identifier?.map(S),source:l.source?.map(S),rights:u(l.rights)},P=n=>f=>{const b=new Set(f.role?.map(v=>G[v]??n));return[b.size?b:[n],f]};for(const[n,f]of[].concat(l.creator?.map(y)?.map(P("author"))??[],l.contributor?.map(y)?.map(P("contributor"))??[]))for(const b of n)E[b]?E[b].push(f):E[b]=[f];O(E),E.altIdentifier===E.identifier&&delete E.altIdentifier;const H={},x={};for(const[n,f]of Object.entries(d))n.startsWith(T.rendition)?H[U(n.replace(T.rendition,""))]=u(f):n.startsWith(T.media)&&(x[U(n.replace(T.media,""))]=u(f));return x.duration&&(x.duration=B(x.duration)),{metadata:E,rendition:H,media:x}},rt=(i,t=e=>e)=>{const{$:e,$$:s,$$$:r}=M(i,w.XHTML),c=m=>m?decodeURI(t(m)):null,o=m=>y=>{const A=e(y,"a")??e(y,"span"),S=e(y,"ol"),$=c(A?.getAttribute("href")),E={label:L(A)||A?.getAttribute("title"),href:$,subitems:h(S)};return m&&(E.type=A?.getAttributeNS(w.EPUB,"type")?.split(/\s/)),E},h=(m,y)=>m?s(m,"li").map(o(y)):null,a=(m,y)=>h(e(m,"ol"),y),l=r(i,"nav");let d=null,p=null,u=null,g=[];for(const m of l){const y=m.getAttributeNS(w.EPUB,"type")?.split(/\s/)??[];y.includes("toc")?d??=a(m):y.includes("page-list")?p??=a(m):y.includes("landmarks")?u??=a(m,!0):g.push({label:L(m.firstElementChild),type:y,list:a(m)})}return{toc:d,pageList:p,landmarks:u,others:g}},it=(i,t=e=>e)=>{const{$:e,$$:s}=M(i,w.NCX),r=a=>a?decodeURI(t(a)):null,c=a=>{const l=e(a,"navLabel"),d=e(a,"content"),p=L(l),u=r(d.getAttribute("src"));if(a.localName==="navPoint"){const g=s(a,"navPoint");return{label:p,href:u,subitems:g.length?g.map(c):null}}return{label:p,href:u}},o=(a,l)=>s(a,l).map(c),h=(a,l)=>{const d=e(i.documentElement,a);return d?o(d,l):null};return{toc:h("navMap","navPoint"),pageList:h("pageList","pageTarget"),others:s(i.documentElement,"navList").map(a=>({label:L(e(a,"navLabel")),list:o(a,"navTarget")}))}},B=i=>{if(!i)return;const t=i.split(":").map(o=>parseFloat(o));if(t.length===3){const[o,h,a]=t;return o*60*60+h*60+a}if(t.length===2){const[o,h]=t;return o*60+h}const[e,s]=i.split(/(?=[^\d.])/);return parseFloat(e)*(s==="h"?3600:s==="min"?60:s==="ms"?.001:1)};class nt extends EventTarget{#e;#s;#t;#n;#i;#r;#d=1;#f=1;#l;constructor(t,e){super(),this.book=t,this.loadXML=e}async#g(t){if(this.#s===t)return;const e=await this.loadXML(t.href),s=o=>o?N(o,t.href):null,{$:r,$$$:c}=M(e,w.SMIL);this.#n=-1,this.#i=-1,this.#e=c(e,"par").reduce((o,h)=>{const a=s(r(h,"text")?.getAttribute("src")),l=r(h,"audio");if(!a||!l)return o;const d=s(l.getAttribute("src")),p=B(l.getAttribute("clipBegin")),u=B(l.getAttribute("clipEnd")),g=o.at(-1);return g?.src===d?g.items.push({text:a,begin:p,end:u}):o.push({src:d,items:[{text:a,begin:p,end:u}]}),o},[]),this.#s=t}get#h(){return this.#e[this.#n]}get#o(){return this.#h?.items?.[this.#i]}#a(t){console.error(t),this.dispatchEvent(new CustomEvent("error",{detail:t}))}#p(){this.dispatchEvent(new CustomEvent("highlight",{detail:this.#o}))}#u(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:this.#o}))}async#c(t,e){this.#m(),this.#n=t,this.#i=e;const s=this.#h?.src;if(!s||!this.#o)return this.start(this.#t+1);const r=URL.createObjectURL(await this.book.loadBlob(s)),c=new Audio(r);this.#r=c,c.volume=this.#d,c.playbackRate=this.#f,c.addEventListener("timeupdate",()=>{if(c.paused)return;const o=c.currentTime,{items:h}=this.#h;if(o>this.#o?.end&&(this.#u(),this.#i===h.length-1)){this.#c(this.#n+1,0).catch(l=>this.#a(l));return}const a=this.#i;for(;h[this.#i+1]?.begin<=o;)this.#i++;this.#i!==a&&this.#p()}),c.addEventListener("error",()=>this.#a(new Error(`Failed to load ${s}`))),c.addEventListener("playing",()=>this.#p()),c.addEventListener("ended",()=>{this.#u(),URL.revokeObjectURL(r),this.#r=null,this.#c(t+1,0).catch(o=>this.#a(o))}),this.#l==="paused"?(this.#p(),c.currentTime=this.#o.begin??0):c.addEventListener("canplaythrough",()=>{c.currentTime=this.#o.begin??0,this.#l="playing",c.play().catch(o=>this.#a(o))},{once:!0})}async start(t,e=()=>!0){this.#r?.pause();const s=this.book.sections[t],r=s?.id;if(!r)return;const{mediaOverlay:c}=s;if(!c)return this.start(t+1);this.#t=t,await this.#g(c);for(let o=0;o<this.#e.length;o++){const{items:h}=this.#e[o];for(let a=0;a<h.length;a++)if(h[a].text.split("#")[0]===r&&e(h[a],a,h))return this.#c(o,a).catch(l=>this.#a(l))}}pause(){this.#l="paused",this.#r?.pause()}resume(){this.#l="playing",this.#r?.play().catch(t=>this.#a(t))}#m(){this.#r&&(this.#r.pause(),URL.revokeObjectURL(this.#r.src),this.#r=null,this.#u())}stop(){this.#l="stopped",this.#m()}prev(){this.#i>0?this.#c(this.#n,this.#i-1):this.#n>0?this.#c(this.#n-1,this.#e[this.#n-1].items.length-1):this.#t>0&&this.start(this.#t-1,(t,e,s)=>e===s.length-1)}next(){this.#c(this.#n,this.#i+1)}setVolume(t){this.#d=t,this.#r&&(this.#r.volume=t)}setRate(t){this.#f=t,this.#r&&(this.#r.playbackRate=t)}}const ot=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,at=i=>{for(const t of i.getElementsByTagNameNS(w.DC,"identifier")){const[e]=L(t).split(":").slice(-1);if(ot.test(e))return e}return""},q=i=>L(i.getElementById(i.documentElement.getAttribute("unique-identifier"))??i.getElementsByTagNameNS(w.DC,"identifier")[0]),j=async(i,t,e)=>{const s=new Uint8Array(await e.slice(0,t).arrayBuffer());t=Math.min(t,s.length);for(var r=0;r<t;r++)s[r]=s[r]^i[r%i.length];return new Blob([s,e.slice(t)],{type:e.type})},ct=async i=>{const t=new TextEncoder().encode(i),e=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(e)},lt=(i=ct)=>({"http://www.idpf.org/2008/embedding":{key:t=>i(q(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(t,e)=>j(t,1040,e)},"http://ns.adobe.com/pdf/enc#RC":{key:t=>{const e=at(t).replaceAll("-","");return Uint8Array.from({length:16},(s,r)=>parseInt(e.slice(r*2,r*2+2),16))},decode:(t,e)=>j(t,1024,e)}});class ht{#e=new Map;#s=new Map;#t;constructor(t){this.#t=t}async init(t,e){if(!t)return;const s=Array.from(t.getElementsByTagNameNS(w.ENC,"EncryptedData"),r=>({algorithm:r.getElementsByTagNameNS(w.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:r.getElementsByTagNameNS(w.ENC,"CipherReference")[0]?.getAttribute("URI")}));for(const{algorithm:r,uri:c}of s){if(!this.#s.has(r)){const o=this.#t[r];if(!o){console.warn("Unknown encryption algorithm");continue}const h=await o.key(e);this.#s.set(r,a=>o.decode(h,a))}this.#e.set(c,r)}}getDecoder(t){return this.#s.get(this.#e.get(t))??(e=>e)}}class pt{constructor({opf:t,resolveHref:e}){this.opf=t;const{$:s,$$:r,$$$:c}=M(t,w.OPF),o=s(t.documentElement,"manifest"),h=s(t.documentElement,"spine"),a=r(h,"itemref");this.manifest=r(o,"item").map(C("href","id","media-type","properties","media-overlay")).map(d=>(d.href=e(d.href),d.properties=d.properties?.split(/\s/),d)),this.spine=a.map(C("idref","id","linear","properties")).map(d=>(d.properties=d.properties?.split(/\s/),d)),this.pageProgressionDirection=h.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(h.getAttribute("toc"))??this.manifest.find(d=>d.mediaType===I.NCX))?.href;const l=s(t.documentElement,"guide");l&&(this.guide=r(l,"reference").map(C("type","title","href")).map(({type:d,title:p,href:u})=>({label:p,type:d.split(/\s/),href:e(u)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(c(t,"meta").find(Q("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find(d=>d.type.includes("cover"))?.href),this.cfis=z(a)}getItemByID(t){return this.manifest.find(e=>e.id===t)}getItemByHref(t){return this.manifest.find(e=>e.href===t)}getItemByProperty(t){return this.manifest.find(e=>e.properties?.includes(t))}resolveCFI(t){const e=W(t),s=(e.parent??e).shift();let r=X(this.opf,s);r&&r.nodeName!=="idref"&&(s.at(-1).id=null,r=X(this.opf,s));const c=r?.getAttribute("idref");return{index:this.spine.findIndex(a=>a.idref===c),anchor:a=>V(a,e)}}}class ut{#e=new Map;#s=new Map;#t=new Map;allowScript=!1;constructor({loadText:t,loadBlob:e,resources:s}){this.loadText=t,this.loadBlob=e,this.manifest=s.manifest,this.assets=s.manifest}createURL(t,e,s,r){if(!e)return"";const c=URL.createObjectURL(new Blob([e],{type:s}));if(this.#e.set(t,c),this.#t.set(t,1),r){const o=this.#s.get(r);o?o.push(t):this.#s.set(r,[t])}return c}ref(t,e){const s=this.#s.get(e);return s?.includes(t)||(this.#t.set(t,this.#t.get(t)+1),s?s.push(t):this.#s.set(e,[t])),this.#e.get(t)}unref(t){if(!this.#t.has(t))return;const e=this.#t.get(t)-1;if(e<1){URL.revokeObjectURL(this.#e.get(t)),this.#e.delete(t),this.#t.delete(t);const s=this.#s.get(t);if(s)for(;s.length;)this.unref(s.pop());this.#s.delete(t)}else this.#t.set(t,e)}async loadItem(t,e=[]){if(!t)return null;const{href:s,mediaType:r}=t,c=I.JS.test(t.mediaType);if(c&&!this.allowScript)return null;const o=e.at(-1);return this.#e.has(s)?this.ref(s,o):(c||[I.XHTML,I.HTML,I.CSS,I.SVG].includes(r))&&e.every(a=>a!==s)?this.loadReplaced(t,e):this.createURL(s,await this.loadBlob(s),r,o)}async loadHref(t,e,s=[]){if(_(t))return t;const r=N(t,e),c=this.manifest.find(o=>o.href===r);return c?this.loadItem(c,s.concat(e)):t}async loadReplaced(t,e=[]){const{href:s,mediaType:r}=t,c=e.at(-1),o=await this.loadText(s);if(!o)return null;if([I.XHTML,I.HTML,I.SVG].includes(r)){let a=new DOMParser().parseFromString(o,r);if(r===I.XHTML&&(a.querySelector("parsererror")||!a.documentElement?.namespaceURI)&&(console.warn(a.querySelector("parsererror")?.innerText??"Invalid XHTML"),t.mediaType=I.HTML,a=new DOMParser().parseFromString(o,t.mediaType)),[I.XHTML,I.SVG].includes(t.mediaType)){let p=a.firstChild;for(;p instanceof ProcessingInstruction;){if(p.data){const u=await k(p.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(g,m,y,A)=>this.loadHref(y,s,e).then(S=>`${m}${S}${A}`));p.replaceWith(a.createProcessingInstruction(p.target,u))}p=p.nextSibling}}const l=async(p,u)=>p.setAttribute(u,await this.loadHref(p.getAttribute(u),s,e));for(const p of a.querySelectorAll("link[href]"))await l(p,"href");for(const p of a.querySelectorAll("[src]"))await l(p,"src");for(const p of a.querySelectorAll("[poster]"))await l(p,"poster");for(const p of a.querySelectorAll("object[data]"))await l(p,"data");for(const p of a.querySelectorAll("[*|href]:not([href])"))p.setAttributeNS(w.XLINK,"href",await this.loadHref(p.getAttributeNS(w.XLINK,"href"),s,e));for(const p of a.querySelectorAll("style"))p.textContent&&(p.textContent=await this.replaceCSS(p.textContent,s,e));for(const p of a.querySelectorAll("[style]"))p.setAttribute("style",await this.replaceCSS(p.getAttribute("style"),s,e));const d=new XMLSerializer().serializeToString(a);return this.createURL(s,d,t.mediaType,c)}const h=r===I.CSS?await this.replaceCSS(o,s,e):await this.replaceString(o,s,e);return this.createURL(s,h,r,c)}async replaceCSS(t,e,s=[]){const r=await k(t,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(a,l)=>this.loadHref(l,e,s).then(d=>`url("${d}")`)),c=await k(r,/@import\s*["']([^"'\n]*?)["']/gi,(a,l)=>this.loadHref(l,e,s).then(d=>`@import "${d}"`)),o=window?.innerWidth??800,h=window?.innerHeight??600;return c.replace(/(?<=[{\s;])-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,(a,l)=>parseFloat(l)*o/100+"px").replace(/(\d*\.?\d+)vh/gi,(a,l)=>parseFloat(l)*h/100+"px").replace(/page-break-(after|before|inside)\s*:/gi,(a,l)=>`-webkit-column-break-${l}:`).replace(/break-(after|before|inside)\s*:\s*(avoid-)?page/gi,(a,l,d)=>`break-${l}: ${d??""}column`)}replaceString(t,e,s=[]){const r=new Map,c=this.assets.map(h=>{if(h.href===e)return;const a=Y(Z(e),h.href),l=encodeURI(a),d="/"+h.href,p=encodeURI(d),u=new Set([a,l,d,p]);for(const g of u)r.set(g,h);return Array.from(u)}).flat().filter(h=>h);if(!c.length)return t;const o=new RegExp(c.map(tt).join("|"),"g");return k(t,o,async h=>this.loadItem(r.get(h.replace(/^\//,"")),s.concat(e)))}unloadItem(t){this.unref(t?.href)}destroy(){for(const t of this.#e.values())URL.revokeObjectURL(t)}}const dt=(i,t)=>i.getElementById(t)??i.querySelector(`[name="${CSS.escape(t)}"]`),ft=i=>{for(const t of i){if(t==="page-spread-left"||t==="rendition:page-spread-left")return"left";if(t==="page-spread-right"||t==="rendition:page-spread-right")return"right";if(t==="rendition:page-spread-center")return"center"}},mt=i=>i?{fixedLayout:L(i.querySelector('option[name="fixed-layout"]')),openToSpread:L(i.querySelector('option[name="open-to-spread"]'))}:null;class yt{parser=new DOMParser;#e;#s;constructor({loadText:t,loadBlob:e,getSize:s,sha1:r}){this.loadText=t,this.loadBlob=e,this.getSize=s,this.#s=new ht(lt(r))}async#t(t){const e=await this.loadText(t);if(!e)return null;const s=this.parser.parseFromString(e,I.XML);if(s.querySelector("parsererror"))throw new Error(`XML parsing error: ${t}
${s.querySelector("parsererror").innerText}`);return s}async init(){const t=await this.#t("META-INF/container.xml");if(!t)throw new Error("Failed to load container file");const e=Array.from(t.getElementsByTagNameNS(w.CONTAINER,"rootfile"),C("full-path","media-type")).filter(u=>u.mediaType==="application/oebps-package+xml");if(!e.length)throw new Error("No package document defined in container");const s=e[0].fullPath,r=await this.#t(s);if(!r)throw new Error("Failed to load package document");const c=await this.#t("META-INF/encryption.xml");await this.#s.init(c,r),this.resources=new pt({opf:r,resolveHref:u=>N(u,s)}),this.#e=new ut({loadText:this.loadText,loadBlob:u=>Promise.resolve(this.loadBlob(u)).then(this.#s.getDecoder(u)),resources:this.resources}),this.sections=this.resources.spine.map((u,g)=>{const{idref:m,linear:y,properties:A=[]}=u,S=this.resources.getItemByID(m);return S?{id:S.href,load:()=>this.#e.loadItem(S),unload:()=>this.#e.unloadItem(S),createDocument:()=>this.loadDocument(S),size:this.getSize(S.href),cfi:this.resources.cfis[g],linear:y,pageSpread:ft(A),resolveHref:$=>N($,S.href),mediaOverlay:S.mediaOverlay?this.resources.getItemByID(S.mediaOverlay):null}:(console.warn(`Could not find item with ID "${m}" in manifest`),null)}).filter(u=>u);const{navPath:o,ncxPath:h}=this.resources;if(o)try{const u=m=>N(m,o),g=rt(await this.#t(o),u);this.toc=g.toc,this.pageList=g.pageList,this.landmarks=g.landmarks}catch(u){console.warn(u)}if(!this.toc&&h)try{const u=m=>N(m,h),g=it(await this.#t(h),u);this.toc=g.toc,this.pageList=g.pageList}catch(u){console.warn(u)}this.landmarks??=this.resources.guide;const{metadata:a,rendition:l,media:d}=st(r);this.metadata=a,this.rendition=l,this.media=d,this.dir=this.resources.pageProgressionDirection;const p=mt(await this.#t("META-INF/com.apple.ibooks.display-options.xml")??await this.#t("META-INF/com.kobobooks.display-options.xml"));return p&&(p.fixedLayout==="true"&&(this.rendition.layout??="pre-paginated"),p.openToSpread==="false"&&(this.sections.find(u=>u.linear!=="no").pageSpread??=this.dir==="rtl"?"left":"right")),this}async loadDocument(t){const e=await this.loadText(t.href);return this.parser.parseFromString(e,t.mediaType)}getMediaOverlay(){return new nt(this,this.#t.bind(this))}resolveCFI(t){return this.resources.resolveCFI(t)}resolveHref(t){const[e,s]=t.split("#"),r=this.resources.getItemByHref(decodeURI(e));return r?{index:this.resources.spine.findIndex(({idref:h})=>h===r.id),anchor:s?h=>dt(h,s):()=>0}:null}splitTOCHref(t){return t?.split("#")??[]}getTOCFragment(t,e){return t.getElementById(e)??t.querySelector(`[name="${CSS.escape(e)}"]`)}isExternal(t){return _(t)}async getCover(){const t=this.resources?.cover;return t?.href?new Blob([await this.loadBlob(t.href)],{type:t.mediaType}):null}async getCalibreBookmarks(){const t=await this.loadText("META-INF/calibre_bookmarks.txt"),e="encoding=json+base64:";if(t?.startsWith(e)){const s=atob(t.slice(e.length));return JSON.parse(s)}}destroy(){this.#e?.destroy()}}export{yt as EPUB};
