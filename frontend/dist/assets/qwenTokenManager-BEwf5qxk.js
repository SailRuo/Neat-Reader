import{b as c}from"./ebook-6ZYtjjao.js";const i="/api/qwen";async function d(){return(await c.post(`${i}/device-auth`)).data}async function _(r){return(await c.post(`${i}/poll-token`,{session_id:r})).data}async function p(r){return(await c.post(`${i}/refresh`,{refresh_token:r})).data}async function D(r,e,t,o){const s=await fetch(`${i}/chat-stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r,message:e,resource_url:t})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=s.body?.getReader();if(!a)throw new Error("Êó†Ê≥ïËé∑ÂèñÂìçÂ∫îÊµÅ");const T=new TextDecoder;let l="";try{for(;;){const{done:u,value:g}=await a.read();if(u)break;l+=T.decode(g,{stream:!0});const h=l.split(`
`);l=h.pop()||"";for(const k of h)if(k.startsWith("data: ")){const f=k.slice(6).trim();if(f==="[DONE]")return;try{const n=JSON.parse(f);if(n.content&&o&&o(n.content),n.error)throw new Error(n.error)}catch(n){if(n instanceof Error&&n.message!=="Unexpected end of JSON input")throw n}}}}finally{a.releaseLock()}}async function S(r,e,t){return(await c.post(`${i}/test`,{access_token:r,message:e,resource_url:t})).data}class w{tokenData=null;refreshTimer=null;onTokenRefreshed=null;onRefreshFailed=null;REFRESH_LEAD_TIME=10800*1e3;constructor(){this.loadFromStorage(),this.scheduleRefresh()}loadFromStorage(){try{const e=localStorage.getItem("qwen_access_token"),t=localStorage.getItem("qwen_refresh_token"),o=localStorage.getItem("qwen_expires_at"),s=localStorage.getItem("qwen_resource_url");e&&t&&o&&(this.tokenData={accessToken:e,refreshToken:t,expiresAt:parseInt(o,10),resourceUrl:s||void 0},console.log("‚úÖ [Token Manager] ‰ªéÂ≠òÂÇ®Âä†ËΩΩ token",{expiresAt:new Date(this.tokenData.expiresAt).toLocaleString(),hasResourceUrl:!!s}))}catch(e){console.error("‚ùå [Token Manager] Âä†ËΩΩ token Â§±Ë¥•:",e)}}saveToStorage(){if(this.tokenData)try{localStorage.setItem("qwen_access_token",this.tokenData.accessToken),localStorage.setItem("qwen_refresh_token",this.tokenData.refreshToken),localStorage.setItem("qwen_expires_at",this.tokenData.expiresAt.toString()),this.tokenData.resourceUrl&&localStorage.setItem("qwen_resource_url",this.tokenData.resourceUrl),console.log("‚úÖ [Token Manager] Token Â∑≤‰øùÂ≠òÂà∞Â≠òÂÇ®")}catch(e){console.error("‚ùå [Token Manager] ‰øùÂ≠ò token Â§±Ë¥•:",e)}}setTokens(e,t,o,s){const a=Date.now()+o*1e3;this.tokenData={accessToken:e,refreshToken:t,expiresAt:a,resourceUrl:s},this.saveToStorage(),this.scheduleRefresh(),console.log("‚úÖ [Token Manager] Token Â∑≤ËÆæÁΩÆ",{expiresAt:new Date(a).toLocaleString(),expiresIn:`${Math.floor(o/60)} ÂàÜÈíü`})}getAccessToken(){return this.tokenData?.accessToken||null}getResourceUrl(){return this.tokenData?.resourceUrl||null}isTokenExpiringSoon(){return this.tokenData?this.tokenData.expiresAt-Date.now()<=this.REFRESH_LEAD_TIME:!1}isTokenExpired(){return this.tokenData?Date.now()>=this.tokenData.expiresAt:!0}scheduleRefresh(){if(this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),!this.tokenData)return;const t=this.tokenData.expiresAt-Date.now()-this.REFRESH_LEAD_TIME;t<=0?(console.log("‚ö†Ô∏è [Token Manager] Token Âç≥Â∞ÜËøáÊúüÔºåÁ´ãÂç≥Âà∑Êñ∞"),this.refreshTokenNow()):(console.log("‚è∞ [Token Manager] ËÆ°ÂàíÂà∑Êñ∞Êó∂Èó¥",{refreshIn:`${Math.floor(t/1e3/60)} ÂàÜÈíü`,refreshAt:new Date(Date.now()+t).toLocaleString()}),this.refreshTimer=window.setTimeout(()=>{this.refreshTokenNow()},t))}async refreshTokenNow(){if(!this.tokenData){console.warn("‚ö†Ô∏è [Token Manager] Ê≤°Êúâ token Êï∞ÊçÆÔºåÊó†Ê≥ïÂà∑Êñ∞");return}console.log("üîÑ [Token Manager] ÂºÄÂßãÂà∑Êñ∞ token...");try{const e=await p(this.tokenData.refreshToken);this.setTokens(e.access_token,e.refresh_token,e.expires_in,e.resource_url||this.tokenData.resourceUrl),console.log("‚úÖ [Token Manager] Token Âà∑Êñ∞ÊàêÂäü"),this.onTokenRefreshed&&this.tokenData&&this.onTokenRefreshed(this.tokenData)}catch(e){console.error("‚ùå [Token Manager] Token Âà∑Êñ∞Â§±Ë¥•:",e),this.onRefreshFailed&&this.onRefreshFailed(e),console.log("‚è∞ [Token Manager] 5 ÂàÜÈíüÂêéÈáçËØïÂà∑Êñ∞"),this.refreshTimer=window.setTimeout(()=>{this.refreshTokenNow()},300*1e3)}}onRefresh(e){this.onTokenRefreshed=e}onError(e){this.onRefreshFailed=e}clearTokens(){this.tokenData=null,this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),localStorage.removeItem("qwen_access_token"),localStorage.removeItem("qwen_refresh_token"),localStorage.removeItem("qwen_expires_at"),localStorage.removeItem("qwen_resource_url"),console.log("‚úÖ [Token Manager] Token Â∑≤Ê∏ÖÈô§")}destroy(){this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.onTokenRefreshed=null,this.onRefreshFailed=null}}const E=new w;export{D as c,_ as p,E as q,p as r,d as s,S as t};
