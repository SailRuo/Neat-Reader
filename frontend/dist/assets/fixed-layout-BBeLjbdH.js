const y=d=>d?.split(/[,;\s]/)?.filter(t=>t)?.map(t=>t.split("=").map(i=>i.trim())),S=(d,t)=>{if(d.documentElement.localName==="svg"){const[,,n,h]=d.documentElement.getAttribute("viewBox")?.split(/\s/)??[];return{width:n,height:h}}const i=y(d.querySelector('meta[name="viewport"]')?.getAttribute("content"));if(i)return Object.fromEntries(i);if(typeof t=="string")return y(t);if(t)return t;const e=d.querySelector("img");return e?{width:e.naturalWidth,height:e.naturalHeight}:(console.warn(new Error("Missing viewport properties")),{width:1e3,height:2e3})};class k extends HTMLElement{static observedAttributes=["zoom"];#l=this.attachShadow({mode:"closed"});#f=new ResizeObserver(()=>this.#o());#s;#n=-1;defaultViewport;spread;#a=!1;#e;#i;#t;#r;#h;constructor(){super();const t=new CSSStyleSheet;this.#l.adoptedStyleSheets=[t],t.replaceSync(`:host {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }`),this.#f.observe(this)}attributeChangedCallback(t,i,e){switch(t){case"zoom":this.#h=e!=="fit-width"&&e!=="fit-page"?parseFloat(e):e,this.#o();break}}async#c({index:t,src:i}){const e=typeof i=="string",n=e?i:i?.src,h=e?null:i?.onZoom,r=document.createElement("div"),o=document.createElement("iframe");return r.append(o),Object.assign(o.style,{border:"0",display:"none",overflow:"hidden"}),o.setAttribute("sandbox","allow-same-origin allow-scripts"),o.setAttribute("scrolling","no"),o.setAttribute("part","filter"),this.#l.append(r),n?new Promise(s=>{o.addEventListener("load",()=>{const c=o.contentDocument;this.dispatchEvent(new CustomEvent("load",{detail:{doc:c,index:t}}));const{width:l,height:a}=S(c,this.defaultViewport);s({element:r,iframe:o,width:parseFloat(l),height:parseFloat(a),onZoom:h})},{once:!0}),o.src=n}):{blank:!0,element:r,iframe:o}}#o(t=this.#r){if(!t)return;const i=this.#e??{},e=this.#t??this.#i,n=t==="left"?i:e,{width:h,height:r}=this.getBoundingClientRect(),o=this.spread!=="both"&&this.spread!=="portrait"&&r>h;this.#a=o;const s=i.width??e.width,c=i.height??e.height,l=typeof this.#h=="number"&&!isNaN(this.#h)?this.#h:this.#h==="fit-width"?o||this.#t?h/(n.width??s):h/((i.width??s)+(e.width??s)):o||this.#t?Math.min(h/(n.width??s),r/(n.height??c)):Math.min(h/((i.width??s)+(e.width??s)),r/Math.max(i.height??c,e.height??c)),a=g=>{let{element:p,iframe:b,width:u,height:m,blank:x,onZoom:f}=g;f&&f({doc:g.iframe.contentDocument,scale:l});const w=f?l:1;Object.assign(b.style,{width:`${u*w}px`,height:`${m*w}px`,transform:f?"none":`scale(${l})`,transformOrigin:"top left",display:x?"none":"block"}),Object.assign(p.style,{width:`${(u??s)*l}px`,height:`${(m??c)*l}px`,overflow:"hidden",display:"block",flexShrink:"0",marginBlock:"auto"}),o&&g!==n&&(p.style.display="none")};this.#t?a(this.#t):(a(i),a(e))}async#g({left:t,right:i,center:e,side:n}){this.#l.replaceChildren(),this.#e=null,this.#i=null,this.#t=null,e?(this.#t=await this.#c(e),this.#r="center",this.#o()):(this.#e=await this.#c(t),this.#i=await this.#c(i),this.#r=this.#e.blank?"right":this.#i.blank?"left":n,this.#o())}#p(){if(!(this.#t||this.#e?.blank)&&this.#a&&this.#e?.element?.style?.display==="none")return this.#i.element.style.display="none",this.#e.element.style.display="block",this.#r="left",!0}#u(){if(!(this.#t||this.#i?.blank)&&this.#a&&this.#i?.element?.style?.display==="none")return this.#e.element.style.display="none",this.#i.element.style.display="block",this.#r="right",!0}open(t){this.book=t;const{rendition:i}=t;this.spread=i?.spread,this.defaultViewport=i?.viewport;const e=t.dir==="rtl",n=!e;this.rtl=e,i?.spread==="none"?this.#s=t.sections.map(h=>({center:h})):this.#s=t.sections.reduce((h,r,o)=>{const s=h[h.length-1],{pageSpread:c}=r,l=()=>{const a={};return h.push(a),a};if(c==="center"){const a=s.left||s.right?l():s;a.center=r}else if(c==="left"){const a=s.center||s.left||n&&o?l():s;a.left=r}else if(c==="right"){const a=s.center||s.right||e&&o?l():s;a.right=r}else n?s.center||s.right?l().left=r:s.left||!o?s.right=r:s.left=r:s.center||s.left?l().right=r:s.right||!o?s.left=r:s.right=r;return h},[{}])}get index(){const t=this.#s[this.#n],i=t?.center??(this.side==="left"?t.left??t.right:t.right??t.left);return this.book.sections.indexOf(i)}#d(t){this.dispatchEvent(new CustomEvent("relocate",{detail:{reason:t,range:null,index:this.index,fraction:0,size:1}}))}getSpreadOf(t){const i=this.#s;for(let e=0;e<i.length;e++){const{left:n,right:h,center:r}=i[e];if(n===t)return{index:e,side:"left"};if(h===t)return{index:e,side:"right"};if(r===t)return{index:e,side:"center"}}}async goToSpread(t,i,e){if(t<0||t>this.#s.length-1)return;if(t===this.#n){this.#o(i);return}this.#n=t;const n=this.#s[t];if(n.center){const h=this.book.sections.indexOf(n.center),r=await n.center?.load?.();await this.#g({center:{index:h,src:r}})}else{const h=this.book.sections.indexOf(n.left),r=this.book.sections.indexOf(n.right),o=await n.left?.load?.(),s=await n.right?.load?.(),c={index:h,src:o},l={index:r,src:s};await this.#g({left:c,right:l,side:i})}this.#d(e)}async select(t){await this.goTo(t)}async goTo(t){const{book:i}=this,e=await t,n=i.sections[e.index];if(!n)return;const{index:h,side:r}=this.getSpreadOf(n);await this.goToSpread(h,r)}async next(){if(this.rtl?this.#p():this.#u())this.#d("page");else return this.goToSpread(this.#n+1,this.rtl?"right":"left","page")}async prev(){if(this.rtl?this.#u():this.#p())this.#d("page");else return this.goToSpread(this.#n-1,this.rtl?"left":"right","page")}getContents(){return Array.from(this.#l.querySelectorAll("iframe"),t=>({doc:t.contentDocument}))}destroy(){this.#f.unobserve(this)}}customElements.define("foliate-fxl",k);export{k as FixedLayout};
