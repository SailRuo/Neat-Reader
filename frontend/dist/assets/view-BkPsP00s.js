const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./epub-yDHPtqZF.js","./index-DzThwDyM.js","./index.tNiFdIF9.css","./pdf-Db0C-tyG.js"])))=>i.map(i=>d[i]);
import{G as p}from"./index-DzThwDyM.js";const q=(i,t)=>i.map((e,s,n)=>t(e,s,n)?s:null).filter(e=>e!=null),B=(i,t)=>[-1,...t,i.length].reduce(({xs:e,a:s},n)=>({xs:e?.concat([i.slice(s+1,n)])??[],a:n}),{}).xs,X=(i,t)=>i.slice(0,-1).concat([i[i.length-1].concat(t[0])]).concat(t.slice(1)),I=/\d/,_=/^epubcfi\((.*)\)$/,L=i=>i.replace(/[\^[\](),;=]/g,"^$&"),D=i=>_.test(i)?i:`epubcfi(${i})`,Q=i=>i.match(_)?.[1]??i,Y=i=>(...t)=>`epubcfi(${i(...t.map(e=>e.match(_)?.[1]??e))})`,tt=Y((...i)=>i.join("!")),et=i=>{const t=[];let e,s,n="";const o=a=>(t.push(a),e=null,n=""),r=a=>(n+=a,s=!1);for(const a of Array.from(i.trim()).concat("")){if(a==="^"&&!s){s=!0;continue}if(e==="!")o(["!"]);else if(e===",")o([","]);else if(e==="/"||e===":")if(I.test(a)){r(a);continue}else o([e,parseInt(n)]);else if(e==="~")if(I.test(a)||a==="."){r(a);continue}else o(["~",parseFloat(n)]);else if(e==="@"){if(a===":"){o(["@",parseFloat(n)]),e="@";continue}if(I.test(a)||a==="."){r(a);continue}else o(["@",parseFloat(n)])}else if(e==="["){a===";"&&!s?(o(["[",n]),e=";"):a===","&&!s?(o(["[",n]),e="["):a==="]"&&!s?o(["[",n]):r(a);continue}else if(e?.startsWith(";")){a==="="&&!s?(e=`;${n}`,n=""):a===";"&&!s?(o([e,n]),e=";"):a==="]"&&!s?o([e,n]):r(a);continue}(a==="/"||a===":"||a==="~"||a==="@"||a==="["||a==="!"||a===",")&&(e=a)}return t},M=(i,t)=>q(i,([e])=>e===t),st=i=>{const t=[];let e;for(const[s,n]of i){if(s==="/")t.push({index:n});else{const o=t[t.length-1];if(s===":")o.offset=n;else if(s==="~")o.temporal=n;else if(s==="@")o.spatial=(o.spatial??[]).concat(n);else if(s===";s")o.side=n;else if(s==="[")if(e==="/"&&n)o.id=n;else{o.text=(o.text??[]).concat(n);continue}}e=s}return t},R=i=>B(i,M(i,"!")).map(st),A=i=>{const t=et(Q(i)),e=M(t,",");if(!e.length)return R(t);const[s,n,o]=B(t,e).map(R);return{parent:s,start:n,end:o}},nt=({index:i,id:t,offset:e,temporal:s,spatial:n,text:o,side:r})=>{const a=r?`;s=${r}`:"";return`/${i}`+(t?`[${L(t)}${a}]`:"")+(e!=null&&i%2?`:${e}`:"")+(s?`~${s}`:"")+(n?`@${n.join(":")}`:"")+(o||!t&&r?"["+(o?.map(L)?.join(",")??"")+a+"]":"")},$=i=>i.parent?[i.parent,i.start,i.end].map($).join(","):i.map(t=>t.map(nt).join("")).join("!"),x=i=>D($(i)),y=(i,t)=>typeof i=="string"?x(y(A(i),t)):i.parent?X(i.parent,i[t?"end":"start"]):i,it=(i,t)=>{typeof i=="string"&&(i=A(i)),typeof t=="string"&&(t=A(t)),i=y(i),t=y(t,!0);const e=i[i.length-1],s=t[t.length-1],n=[],o=[],r=[];let a=!0;const c=Math.max(e.length,s.length);for(let l=0;l<c;l++){const u=e[l],d=s[l];a&&=u?.index===d?.index&&!u?.offset&&!d?.offset,a?n.push(u):(u&&o.push(u),d&&r.push(d))}const h=i.slice(0,-1).concat([n]);return x({parent:h,start:[o],end:[r]})},P=({nodeType:i})=>i===3||i===4,E=({nodeType:i})=>i===1,W=(i,t)=>{const e=Array.from(i.childNodes).filter(s=>P(s)||E(s));return t?e.map(s=>{const n=t(s);return n===NodeFilter.FILTER_REJECT?null:n===NodeFilter.FILTER_SKIP?W(s,t):s}).flat().filter(s=>s):e},C=(i,t)=>{const e=W(i,t).reduce((s,n)=>{let o=s[s.length-1];return o?P(n)?Array.isArray(o)?o.push(n):P(o)?s[s.length-1]=[o,n]:s.push(n):E(o)?s.push(null,n):s.push(n):s.push(n),s},[]);return E(e[0])&&e.unshift("first"),E(e[e.length-1])&&e.push("last"),e.unshift("before"),e.push("after"),e},F=(i,t,e)=>{const{id:s}=t[t.length-1];if(s){const r=i.ownerDocument.getElementById(s);if(r)return{node:r,offset:0}}for(const{index:r}of t){const a=i?C(i,e)[r]:null;if(a==="first")return{node:i.firstChild??i};if(a==="last")return{node:i.lastChild??i};if(a==="before")return{node:i,before:!0};if(a==="after")return{node:i,after:!0};i=a}const{offset:n}=t[t.length-1];if(!Array.isArray(i))return{node:i,offset:n};let o=0;for(const r of i){const{length:a}=r.nodeValue;if(o+a>=n)return{node:r,offset:n-o};o+=a}},T=(i,t,e)=>{const{parentNode:s,id:n}=i,o=C(s,e),r=o.findIndex(h=>Array.isArray(h)?h.some(l=>l===i):h===i),a=o[r];if(Array.isArray(a)){let h=0;for(const l of a)if(l===i){h+=t;break}else h+=l.nodeValue.length;t=h}const c={id:n,index:r,offset:t};return(s!==i.ownerDocument.documentElement?T(s,null,e).concat(c):[c]).filter(h=>h.index!==-1)},ot=(i,t)=>{const{startContainer:e,startOffset:s,endContainer:n,endOffset:o}=i,r=T(e,s,t);if(i.collapsed)return x([r]);const a=T(n,o,t);return it([r],[a])},rt=(i,t,e)=>{const s=y(t),n=y(t,!0),o=i.documentElement,r=F(o,s[0],e),a=F(o,n[0],e),c=i.createRange();return r.before?c.setStartBefore(r.node):r.after?c.setStartAfter(r.node):c.setStart(r.node,r.offset),a.before?c.setEndBefore(a.node):a.after?c.setEndAfter(a.node):c.setEnd(a.node,a.offset),c},_t=i=>{const t=[],{parentNode:e}=i[0],s=T(e);for(const[n,o]of C(e).entries()){const r=i[t.length];o===r&&t.push(x([s.concat({id:r.id,index:n})]))}return t},xt=(i,t)=>F(i.documentElement,y(t)).node,O={fromIndex:i=>D(`/6/${(i+1)*2}`),toIndex:i=>i?.at(-1).index/2-1},at=i=>{let t=0;const e=s=>{if(s.id=t++,s.subitems)for(const n of s.subitems)e(n)};for(const s of i)e(s);return i},j=i=>i.map(t=>t.subitems?.length?[t,j(t.subitems)].flat():t).flat();class k{async init({toc:t,ids:e,splitHref:s,getFragment:n}){at(t);const o=j(t),r=new Map;for(const[c,h]of o.entries()){const[l,u]=await s(h?.href)??[],d={fragment:u,item:h};r.has(l)?r.get(l).items.push(d):r.set(l,{prev:o[c-1],items:[d]})}const a=new Map;for(const[c,h]of e.entries())r.has(h)?a.set(h,r.get(h)):a.set(h,a.get(e[c-1]));this.ids=e,this.map=a,this.getFragment=n}getProgress(t,e){if(!this.ids)return;const s=this.ids[t],n=this.map.get(s);if(!n)return null;const{prev:o,items:r}=n;if(!r)return o;if(!e||r.length===1&&!r[0].fragment)return r[0].item;const a=e.startContainer.getRootNode();for(const[c,{fragment:h}]of r.entries()){const l=this.getFragment(a,h);if(l&&e.comparePoint(l,0)>0)return r[c-1]?.item??o}return r[r.length-1].item}}class ct{constructor(t,e,s){this.sizes=t.map(n=>n.linear!="no"&&n.size>0?n.size:0),this.sizePerLoc=e,this.sizePerTimeUnit=s,this.sizeTotal=this.sizes.reduce((n,o)=>n+o,0),this.sectionFractions=this.#e()}#e(){const{sizeTotal:t}=this,e=[0];let s=0;for(const n of this.sizes)e.push((s+=n)/t);return e}getProgress(t,e,s=0){const{sizes:n,sizePerLoc:o,sizePerTimeUnit:r,sizeTotal:a}=this,c=n[t]??0,l=n.slice(0,t).reduce((m,w)=>m+w,0)+e*c,u=l+s*c,d=a-l,f=(1-e)*c;return{fraction:u/a,section:{current:t,total:n.length},location:{current:Math.floor(l/o),next:Math.floor(u/o),total:Math.ceil(a/o)},time:{section:f/r,total:d/r}}}getSection(t){if(t<=0)return[0,0];if(t>=1)return[this.sizes.length-1,1];t=t+Number.EPSILON;const{sizeTotal:e}=this;let s=this.sectionFractions.findIndex(o=>o>t)-1;if(s<0)return[0,0];for(;!this.sizes[s];)s++;const n=(t-this.sectionFractions[s])/(this.sizes[s]/e);return[s,n]}}const g=i=>document.createElementNS("http://www.w3.org/2000/svg",i);class N{#e=g("svg");#t=new Map;constructor(){Object.assign(this.#e.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"})}get element(){return this.#e}add(t,e,s,n){this.#t.has(t)&&this.remove(t),typeof e=="function"&&(e=e(this.#e.getRootNode()));const o=e.getClientRects(),r=s(o,n);this.#e.append(r),this.#t.set(t,{range:e,draw:s,options:n,element:r,rects:o})}remove(t){this.#t.has(t)&&(this.#e.removeChild(this.#t.get(t).element),this.#t.delete(t))}redraw(){for(const t of this.#t.values()){const{range:e,draw:s,options:n,element:o}=t;this.#e.removeChild(o);const r=e.getClientRects(),a=s(r,n);this.#e.append(a),t.element=a,t.rects=r}}hitTest({x:t,y:e}){const s=Array.from(this.#t.entries());for(let n=s.length-1;n>=0;n--){const[o,r]=s[n];for(const{left:a,top:c,right:h,bottom:l}of r.rects)if(c<=e&&a<=t&&l>e&&h>t)return[o,r.range]}return[]}static underline(t,e={}){const{color:s="red",width:n=2,writingMode:o}=e,r=g("g");if(r.setAttribute("fill",s),o==="vertical-rl"||o==="vertical-lr")for(const{right:a,top:c,height:h}of t){const l=g("rect");l.setAttribute("x",a-n),l.setAttribute("y",c),l.setAttribute("height",h),l.setAttribute("width",n),r.append(l)}else for(const{left:a,bottom:c,width:h}of t){const l=g("rect");l.setAttribute("x",a),l.setAttribute("y",c-n),l.setAttribute("height",n),l.setAttribute("width",h),r.append(l)}return r}static strikethrough(t,e={}){const{color:s="red",width:n=2,writingMode:o}=e,r=g("g");if(r.setAttribute("fill",s),o==="vertical-rl"||o==="vertical-lr")for(const{right:a,left:c,top:h,height:l}of t){const u=g("rect");u.setAttribute("x",(a+c)/2),u.setAttribute("y",h),u.setAttribute("height",l),u.setAttribute("width",n),r.append(u)}else for(const{left:a,top:c,bottom:h,width:l}of t){const u=g("rect");u.setAttribute("x",a),u.setAttribute("y",(c+h)/2),u.setAttribute("height",n),u.setAttribute("width",l),r.append(u)}return r}static squiggly(t,e={}){const{color:s="red",width:n=2,writingMode:o}=e,r=g("g");r.setAttribute("fill","none"),r.setAttribute("stroke",s),r.setAttribute("stroke-width",n);const a=n*1.5;if(o==="vertical-rl"||o==="vertical-lr")for(const{right:c,top:h,height:l}of t){const u=g("path"),d=Math.round(l/a/1.5),f=l/d,m=Array.from({length:d},(w,v)=>`l${v%2?-a:a} ${f}`).join("");u.setAttribute("d",`M${c} ${h}${m}`),r.append(u)}else for(const{left:c,bottom:h,width:l}of t){const u=g("path"),d=Math.round(l/a/1.5),f=l/d,m=Array.from({length:d},(w,v)=>`l${f} ${v%2?a:-a}`).join("");u.setAttribute("d",`M${c} ${h}${m}`),r.append(u)}return r}static highlight(t,e={}){const{color:s="red"}=e,n=g("g");n.setAttribute("fill",s),n.style.opacity="var(--overlayer-highlight-opacity, .3)",n.style.mixBlendMode="var(--overlayer-highlight-blend-mode, normal)";for(const{left:o,top:r,height:a,width:c}of t){const h=g("rect");h.setAttribute("x",o),h.setAttribute("y",r),h.setAttribute("height",a),h.setAttribute("width",c),n.append(h)}return n}static outline(t,e={}){const{color:s="red",width:n=3,radius:o=3}=e,r=g("g");r.setAttribute("fill","none"),r.setAttribute("stroke",s),r.setAttribute("stroke-width",n);for(const{left:a,top:c,height:h,width:l}of t){const u=g("rect");u.setAttribute("x",a),u.setAttribute("y",c),u.setAttribute("height",h),u.setAttribute("width",l),u.setAttribute("rx",o),r.append(u)}return r}static copyImage([t],e={}){const{src:s}=e,n=g("image"),{left:o,top:r,height:a,width:c}=t;return n.setAttribute("href",s),n.setAttribute("x",o),n.setAttribute("y",r),n.setAttribute("height",a),n.setAttribute("width",c),n}}const lt=(i,t)=>{const e=[];for(let s=t.currentNode;s;s=t.nextNode()){const n=i.comparePoint(s,0);if(n===0)e.push(s);else if(n>0)break}return e},ht=(i,t)=>{const e=[];for(let s=t.nextNode();s;s=t.nextNode())e.push(s);return e},ut=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,dt=i=>{if(i.nodeType===1){const t=i.tagName.toLowerCase();return t==="script"||t==="style"?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},z=function*(i,t){const e=i.commonAncestorContainer??i.body??i,s=document.createTreeWalker(e,ut,{acceptNode:dt}),o=(i.commonAncestorContainer?lt:ht)(i,s),r=o.map(c=>c.nodeValue),a=(c,h,l,u)=>{const d=document.createRange();return d.setStart(o[c],h),d.setEnd(o[l],u),d};for(const c of t(r,a))yield c},b="foliate-search:",ft=async i=>{const t=new Uint8Array(await i.slice(0,4).arrayBuffer());return t[0]===80&&t[1]===75&&t[2]===3&&t[3]===4},gt=async i=>{const t=new Uint8Array(await i.slice(0,5).arrayBuffer());return t[0]===37&&t[1]===80&&t[2]===68&&t[3]===70&&t[4]===45},mt=({name:i,type:t})=>t==="application/vnd.comicbook+zip"||i.endsWith(".cbz"),pt=({name:i,type:t})=>t==="application/x-fictionbook+xml"||i.endsWith(".fb2"),wt=({name:i,type:t})=>t==="application/x-zip-compressed-fb2"||i.endsWith(".fb2.zip")||i.endsWith(".fbz"),yt=async i=>{const{configure:t,ZipReader:e,BlobReader:s,TextWriter:n,BlobWriter:o}=await p(async()=>{const{configure:f,ZipReader:m,BlobReader:w,TextWriter:v,BlobWriter:K}=await import("./zip-CGKXlQL7.js");return{configure:f,ZipReader:m,BlobReader:w,TextWriter:v,BlobWriter:K}},[],import.meta.url);t({useWebWorkers:!1});const a=await new e(new s(i)).getEntries(),c=new Map(a.map(f=>[f.filename,f])),h=f=>(m,...w)=>c.has(m)?f(c.get(m),...w):null,l=h(f=>f.getData(new n)),u=h((f,m)=>f.getData(new o(m)));return{entries:a,loadText:l,loadBlob:u,getSize:f=>c.get(f)?.uncompressedSize??0}},V=async i=>i.isFile?i:(await Promise.all(Array.from(await new Promise((t,e)=>i.createReader().readEntries(s=>t(s),s=>e(s))),V))).flat(),vt=async i=>{const t=await V(i),e=await Promise.all(t.map(l=>new Promise((u,d)=>l.file(f=>u([f,l.fullPath]),f=>d(f))))),s=new Map(e.map(([l,u])=>[u.replace(i.fullPath+"/",""),l])),n=new TextDecoder,o=l=>l?n.decode(l):null,r=l=>s.get(l)?.arrayBuffer()??null;return{loadText:async l=>o(await r(l)),loadBlob:l=>s.get(l),getSize:l=>s.get(l)?.size??0}};class H extends Error{}class U extends Error{}class Z extends Error{}const bt=async i=>{const t=await fetch(i);if(!t.ok)throw new H(`${t.status} ${t.statusText}`,{cause:t});return new File([await t.blob()],new URL(t.url).pathname)},G=async i=>{typeof i=="string"&&(i=await bt(i));let t;if(i.isDirectory){const e=await vt(i),{EPUB:s}=await p(async()=>{const{EPUB:n}=await import("./epub-yDHPtqZF.js");return{EPUB:n}},__vite__mapDeps([0,1,2]),import.meta.url);t=await new s(e).init()}else if(i.size)if(await ft(i)){const e=await yt(i);if(mt(i)){const{makeComicBook:s}=await p(async()=>{const{makeComicBook:n}=await import("./comic-book-DhXwm17Z.js");return{makeComicBook:n}},[],import.meta.url);t=s(e,i)}else if(wt(i)){const{makeFB2:s}=await p(async()=>{const{makeFB2:a}=await import("./fb2-C12VRWQn.js");return{makeFB2:a}},[],import.meta.url),{entries:n}=e,o=n.find(a=>a.filename.endsWith(".fb2")),r=await e.loadBlob((o??n[0]).filename);t=await s(r)}else{const{EPUB:s}=await p(async()=>{const{EPUB:n}=await import("./epub-yDHPtqZF.js");return{EPUB:n}},__vite__mapDeps([0,1,2]),import.meta.url);t=await new s(e).init()}}else if(await gt(i)){const{makePDF:e}=await p(async()=>{const{makePDF:s}=await import("./pdf-Db0C-tyG.js");return{makePDF:s}},__vite__mapDeps([3,1,2]),import.meta.url);t=await e(i)}else{const{isMOBI:e,MOBI:s}=await p(async()=>{const{isMOBI:n,MOBI:o}=await import("./mobi-Du_U6_-5.js");return{isMOBI:n,MOBI:o}},[],import.meta.url);if(await e(i)){const n=await p(()=>import("./fflate-CtUkkcu7.js"),[],import.meta.url);t=await new s({unzlib:n.unzlibSync}).open(i)}else if(pt(i)){const{makeFB2:n}=await p(async()=>{const{makeFB2:o}=await import("./fb2-C12VRWQn.js");return{makeFB2:o}},[],import.meta.url);t=await n(i)}}else throw new U("File not found");if(!t)throw new Z("File type not supported");return t};class S{#e;#t;#n;#s;constructor(t,e,s={}){this.#t=t,this.#n=e,this.#s=s,this.#s.hidden&&this.hide(),this.#t.addEventListener("mousemove",({screenX:n,screenY:o})=>{n===this.#s.x&&o===this.#s.y||(this.#s.x=n,this.#s.y=o,this.show(),this.#e&&clearTimeout(this.#e),e()&&(this.#e=setTimeout(this.hide.bind(this),1e3)))},!1)}cloneFor(t){return new S(t,this.#n,this.#s)}hide(){this.#t.style.cursor="none",this.#s.hidden=!0}show(){this.#t.style.removeProperty("cursor"),this.#s.hidden=!1}}class Et extends EventTarget{#e=[];#t=-1;pushState(t){const e=this.#e[this.#t];e===t||e?.fraction&&e.fraction===t.fraction||(this.#e[++this.#t]=t,this.#e.length=this.#t+1,this.dispatchEvent(new Event("index-change")))}replaceState(t){const e=this.#t;this.#e[e]=t}back(){const t=this.#t;if(t<=0)return;const e={state:this.#e[t-1]};this.#t=t-1,this.dispatchEvent(new CustomEvent("popstate",{detail:e})),this.dispatchEvent(new Event("index-change"))}forward(){const t=this.#t;if(t>=this.#e.length-1)return;const e={state:this.#e[t+1]};this.#t=t+1,this.dispatchEvent(new CustomEvent("popstate",{detail:e})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return this.#t>0}get canGoForward(){return this.#t<this.#e.length-1}clear(){this.#e=[],this.#t=-1}}const At=i=>{if(!i)return{};try{const t=Intl.getCanonicalLocales(i)[0],e=new Intl.Locale(t),s=["zh","ja","kr"].includes(e.language),n=(e.getTextInfo?.()??e.textInfo)?.direction;return{canonical:t,locale:e,isCJK:s,direction:n}}catch(t){return console.warn(t),{}}};class J extends HTMLElement{#e=this.attachShadow({mode:"closed"});#t;#n;#s;#o=new Map;#a=new S(this,()=>this.hasAttribute("autohide-cursor"));isFixedLayout=!1;lastLocation;history=new Et;constructor(){super(),this.history.addEventListener("popstate",({detail:t})=>{const e=this.resolveNavigation(t.state);this.renderer.goTo(e)})}async open(t){if((typeof t=="string"||typeof t.arrayBuffer=="function"||t.isDirectory)&&(t=await G(t)),this.book=t,this.language=At(t.metadata?.language),t.splitTOCHref&&t.getTOCFragment){const e=t.sections.map(o=>o.id);this.#t=new ct(t.sections,1500,1600);const s=t.splitTOCHref.bind(t),n=t.getTOCFragment.bind(t);this.#n=new k,await this.#n.init({toc:t.toc??[],ids:e,splitHref:s,getFragment:n}),this.#s=new k,await this.#s.init({toc:t.pageList??[],ids:e,splitHref:s,getFragment:n})}if(this.isFixedLayout=this.book.rendition?.layout==="pre-paginated",this.isFixedLayout?(await p(()=>import("./fixed-layout-BBeLjbdH.js"),[],import.meta.url),this.renderer=document.createElement("foliate-fxl")):(await p(()=>import("./paginator-DE74fLq0.js"),[],import.meta.url),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter"),this.renderer.addEventListener("load",e=>this.#l(e.detail)),this.renderer.addEventListener("relocate",e=>this.#c(e.detail)),this.renderer.addEventListener("create-overlayer",e=>e.detail.attach(this.#u(e.detail))),this.renderer.open(t),this.#e.append(this.renderer),t.sections.some(e=>e.mediaOverlay)){const e=t.media.activeClass,s=t.media.playbackActiveClass;this.mediaOverlay=t.getMediaOverlay();let n;this.mediaOverlay.addEventListener("highlight",o=>{const r=this.resolveNavigation(o.detail.text);this.renderer.goTo(r).then(()=>{const{doc:a}=this.renderer.getContents().find(h=>h.index=r.index),c=r.anchor(a);c.classList.add(e),s&&c.ownerDocument.documentElement.classList.add(s),n=new WeakRef(c)})}),this.mediaOverlay.addEventListener("unhighlight",()=>{const o=n?.deref();o&&(o.classList.remove(e),s&&o.ownerDocument.documentElement.classList.remove(s))})}}close(){this.renderer?.destroy(),this.renderer?.remove(),this.#t=null,this.#n=null,this.#s=null,this.#o=new Map,this.lastLocation=null,this.history.clear(),this.tts=null,this.mediaOverlay=null}goToTextStart(){return this.goTo(this.book.landmarks?.find(t=>t.type.includes("bodymatter")||t.type.includes("text"))?.href??this.book.sections.findIndex(t=>t.linear!=="no"))}async init({lastLocation:t,showTextStart:e}){const s=t?this.resolveNavigation(t):null;s?(await this.renderer.goTo(s),this.history.pushState(t)):e?await this.goToTextStart():(this.history.pushState(0),await this.next())}#i(t,e,s){return this.dispatchEvent(new CustomEvent(t,{detail:e,cancelable:s}))}#c({reason:t,range:e,index:s,fraction:n,size:o}){const r=this.#t?.getProgress(s,n,o)??{},a=this.#n?.getProgress(s,e),c=this.#s?.getProgress(s,e),h=this.getCFI(s,e);this.lastLocation={...r,tocItem:a,pageItem:c,cfi:h,range:e},(t==="snap"||t==="page"||t==="scroll")&&this.history.replaceState(h),this.#i("relocate",this.lastLocation)}#l({doc:t,index:e}){t.documentElement.lang||=this.language.canonical??"",this.language.isCJK||(t.documentElement.dir||=this.language.direction??""),this.#h(t,e),this.#a.cloneFor(t.documentElement),this.#i("load",{doc:t,index:e})}#h(t,e){const{book:s}=this,n=s.sections[e];t.addEventListener("click",o=>{const r=o.target.closest("a[href]");if(!r)return;o.preventDefault();const a=r.getAttribute("href"),c=n?.resolveHref?.(a)??a;s?.isExternal?.(c)?Promise.resolve(this.#i("external-link",{a:r,href:c},!0)).then(h=>h?globalThis.open(c,"_blank"):null).catch(h=>console.error(h)):Promise.resolve(this.#i("link",{a:r,href:c},!0)).then(h=>h?this.goTo(c):null).catch(h=>console.error(h))})}async addAnnotation(t,e){const{value:s}=t;if(s.startsWith(b)){const c=s.replace(b,""),{index:h,anchor:l}=await this.resolveNavigation(c),u=this.#r(h);if(u){const{overlayer:d,doc:f}=u;if(e){d.remove(s);return}const m=f?l(f):l;d.add(s,m,N.outline)}return}const{index:n,anchor:o}=await this.resolveNavigation(s),r=this.#r(n);if(r){const{overlayer:c,doc:h}=r;if(c.remove(s),!e){const l=h?o(h):o,u=(d,f)=>c.add(s,l,d,f);this.#i("draw-annotation",{draw:u,annotation:t,doc:h,range:l})}}const a=this.#n.getProgress(n)?.label??"";return{index:n,label:a}}deleteAnnotation(t){return this.addAnnotation(t,!0)}#r(t){return this.renderer.getContents().find(e=>e.index===t&&e.overlayer)}#u({doc:t,index:e}){const s=new N;t.addEventListener("click",o=>{const[r,a]=s.hitTest(o);r&&!r.startsWith(b)&&this.#i("show-annotation",{value:r,index:e,range:a})},!1);const n=this.#o.get(e);if(n)for(const o of n)this.addAnnotation(o);return this.#i("create-overlay",{index:e}),s}async showAnnotation(t){const{value:e}=t,s=await this.goTo(e);if(s){const{index:n,anchor:o}=s,{doc:r}=this.#r(n),a=o(r);this.#i("show-annotation",{value:e,index:n,range:a})}}getCFI(t,e){const s=this.book.sections[t].cfi??O.fromIndex(t);return e?tt(s,ot(e)):s}resolveCFI(t){if(this.book.resolveCFI)return this.book.resolveCFI(t);{const e=A(t);return{index:O.toIndex((e.parent??e).shift()),anchor:o=>rt(o,e)}}}resolveNavigation(t){try{if(typeof t=="number")return{index:t};if(typeof t.fraction=="number"){const[e,s]=this.#t.getSection(t.fraction);return{index:e,anchor:s}}return _.test(t)?this.resolveCFI(t):this.book.resolveHref(t)}catch(e){console.error(e),console.error(`Could not resolve target ${t}`)}}async goTo(t){const e=this.resolveNavigation(t);try{return await this.renderer.goTo(e),this.history.pushState(t),e}catch(s){console.error(s),console.error(`Could not go to ${t}`)}}async goToFraction(t){const[e,s]=this.#t.getSection(t);await this.renderer.goTo({index:e,anchor:s}),this.history.pushState({fraction:t})}async select(t){try{const e=await this.resolveNavigation(t);await this.renderer.goTo({...e,select:!0}),this.history.pushState(t)}catch(e){console.error(e),console.error(`Could not go to ${t}`)}}deselect(){for(const{doc:t}of this.renderer.getContents())t.defaultView.getSelection().removeAllRanges()}getSectionFractions(){return(this.#t?.sectionFractions??[]).map(t=>t+Number.EPSILON)}getProgressOf(t,e){const s=this.#n?.getProgress(t,e),n=this.#s?.getProgress(t,e);return{tocItem:s,pageItem:n}}async getTOCItemOf(t){try{const{index:e,anchor:s}=await this.resolveNavigation(t),n=await this.book.sections[e].createDocument(),o=s(n),r=o instanceof Range,a=r?o:n.createRange();return r||a.selectNodeContents(o),this.#n.getProgress(e,a)}catch(e){console.error(e),console.error(`Could not get ${t}`)}}async prev(t){await this.renderer.prev(t)}async next(t){await this.renderer.next(t)}goLeft(){return this.book.dir==="rtl"?this.next():this.prev()}goRight(){return this.book.dir==="rtl"?this.prev():this.next()}async*#d(t,e,s){const n=await this.book.sections[s].createDocument();for(const{range:o,excerpt:r}of t(n,e))yield{cfi:this.getCFI(s,o),excerpt:r}}async*#f(t,e){const{sections:s}=this.book;for(const[n,{createDocument:o}]of s.entries()){if(!o)continue;const r=await o(),a=Array.from(t(r,e),({range:h,excerpt:l})=>({cfi:this.getCFI(n,h),excerpt:l}));yield{progress:(n+1)/s.length},a.length&&(yield{index:n,subitems:a})}}async*search(t){this.clearSearch();const{searchMatcher:e}=await p(async()=>{const{searchMatcher:c}=await import("./search-D7qEUpRP.js");return{searchMatcher:c}},[],import.meta.url),{query:s,index:n}=t,o=e(z,{defaultLocale:this.language,...t}),r=n!=null?this.#d(o,s,n):this.#f(o,s),a=[];this.#o.set(n,a);for await(const c of r)if(c.subitems){const h=c.subitems.map(({cfi:l})=>({value:b+l}));this.#o.set(c.index,h);for(const l of h)this.addAnnotation(l);yield{label:this.#n.getProgress(c.index)?.label??"",subitems:c.subitems}}else{if(c.cfi){const h={value:b+c.cfi};a.push(h),this.addAnnotation(h)}yield c}yield"done"}clearSearch(){for(const t of this.#o.values())for(const e of t)this.deleteAnnotation(e);this.#o.clear()}async initTTS(){const t=this.renderer.getContents()[0].doc;if(this.tts&&this.tts.doc===t)return;const{TTS:e}=await p(async()=>{const{TTS:s}=await import("./tts-DB8Rp_Zw.js");return{TTS:s}},[],import.meta.url);this.tts=new e(t,z,s=>this.renderer.scrollToAnchor(s,!0))}startMediaOverlay(){const{index:t}=this.renderer.getContents()[0];return this.mediaOverlay.start(t)}}customElements.define("foliate-view",J);const It=Object.freeze(Object.defineProperty({__proto__:null,NotFoundError:U,ResponseError:H,UnsupportedTypeError:Z,View:J,makeBook:G},Symbol.toStringTag,{value:"Module"}));export{rt as a,_t as f,A as p,xt as t,It as v};
