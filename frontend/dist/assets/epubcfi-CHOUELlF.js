const b=(t,e)=>t.map((n,s,r)=>e(n,s,r)?s:null).filter(n=>n!=null),T=(t,e)=>[-1,...e,t.length].reduce(({xs:n,a:s},r)=>({xs:n?.concat([t.slice(s+1,r)])??[],a:r}),{}).xs,w=(t,e)=>t.slice(0,-1).concat([t[t.length-1].concat(e[0])]).concat(e.slice(1)),y=/\d/,E=/^epubcfi\((.*)\)$/,N=t=>t.replace(/[\^[\](),;=]/g,"^$&"),S=t=>E.test(t)?t:`epubcfi(${t})`,B=t=>t.match(E)?.[1]??t,M=t=>(...e)=>`epubcfi(${t(...e.map(n=>n.match(E)?.[1]??n))})`,V=M((...t)=>t.join("!")),v=t=>{const e=[];let n,s,r="";const i=o=>(e.push(o),n=null,r=""),c=o=>(r+=o,s=!1);for(const o of Array.from(t.trim()).concat("")){if(o==="^"&&!s){s=!0;continue}if(n==="!")i(["!"]);else if(n===",")i([","]);else if(n==="/"||n===":")if(y.test(o)){c(o);continue}else i([n,parseInt(r)]);else if(n==="~")if(y.test(o)||o==="."){c(o);continue}else i(["~",parseFloat(r)]);else if(n==="@"){if(o===":"){i(["@",parseFloat(r)]),n="@";continue}if(y.test(o)||o==="."){c(o);continue}else i(["@",parseFloat(r)])}else if(n==="["){o===";"&&!s?(i(["[",r]),n=";"):o===","&&!s?(i(["[",r]),n="["):o==="]"&&!s?i(["[",r]):c(o);continue}else if(n?.startsWith(";")){o==="="&&!s?(n=`;${r}`,r=""):o===";"&&!s?(i([n,r]),n=";"):o==="]"&&!s?i([n,r]):c(o);continue}(o==="/"||o===":"||o==="~"||o==="@"||o==="["||o==="!"||o===",")&&(n=o)}return e},j=(t,e)=>b(t,([n])=>n===e),D=t=>{const e=[];let n;for(const[s,r]of t){if(s==="/")e.push({index:r});else{const i=e[e.length-1];if(s===":")i.offset=r;else if(s==="~")i.temporal=r;else if(s==="@")i.spatial=(i.spatial??[]).concat(r);else if(s===";s")i.side=r;else if(s==="[")if(n==="/"&&r)i.id=r;else{i.text=(i.text??[]).concat(r);continue}}n=s}return e},C=t=>T(t,j(t,"!")).map(D),p=t=>{const e=v(B(t)),n=j(e,",");if(!n.length)return C(e);const[s,r,i]=T(e,n).map(C);return{parent:s,start:r,end:i}},L=({index:t,id:e,offset:n,temporal:s,spatial:r,text:i,side:c})=>{const o=c?`;s=${c}`:"";return`/${t}`+(e?`[${N(e)}${o}]`:"")+(n!=null&&t%2?`:${n}`:"")+(s?`~${s}`:"")+(r?`@${r.join(":")}`:"")+(i||!e&&c?"["+(i?.map(N)?.join(",")??"")+o+"]":"")},P=t=>t.parent?[t.parent,t.start,t.end].map(P).join(","):t.map(e=>e.map(L).join("")).join("!"),d=t=>S(P(t)),a=(t,e)=>typeof t=="string"?d(a(p(t),e)):t.parent?w(t.parent,t[e?"end":"start"]):t,R=(t,e)=>{typeof t=="string"&&(t=p(t)),typeof e=="string"&&(e=p(e)),t=a(t),e=a(e,!0);const n=t[t.length-1],s=e[e.length-1],r=[],i=[],c=[];let o=!0;const f=Math.max(n.length,s.length);for(let u=0;u<f;u++){const h=n[u],m=s[u];o&&=h?.index===m?.index&&!h?.offset&&!m?.offset,o?r.push(h):(h&&i.push(h),m&&c.push(m))}const l=t.slice(0,-1).concat([r]);return d({parent:l,start:[i],end:[c]})},F=(t,e)=>{if(typeof t=="string"&&(t=p(t)),typeof e=="string"&&(e=p(e)),t.start||e.start)return F(a(t),a(e))||F(a(t,!0),a(e,!0));for(let n=0;n<Math.max(t.length,e.length);n++){const s=t[n],r=e[n],i=Math.max(s.length,r.length)-1;for(let c=0;c<=i;c++){const o=s[c],f=r[c];if(!o)return-1;if(!f||o.index>f.index)return 1;if(o.index<f.index)return-1;if(c===i){if(o.offset>f.offset)return 1;if(o.offset<f.offset)return-1}}}return 0},I=({nodeType:t})=>t===3||t===4,g=({nodeType:t})=>t===1,k=(t,e)=>{const n=Array.from(t.childNodes).filter(s=>I(s)||g(s));return e?n.map(s=>{const r=e(s);return r===NodeFilter.FILTER_REJECT?null:r===NodeFilter.FILTER_SKIP?k(s,e):s}).flat().filter(s=>s):n},$=(t,e)=>{const n=k(t,e).reduce((s,r)=>{let i=s[s.length-1];return i?I(r)?Array.isArray(i)?i.push(r):I(i)?s[s.length-1]=[i,r]:s.push(r):g(i)?s.push(null,r):s.push(r):s.push(r),s},[]);return g(n[0])&&n.unshift("first"),g(n[n.length-1])&&n.push("last"),n.unshift("before"),n.push("after"),n},A=(t,e,n)=>{const{id:s}=e[e.length-1];if(s){const c=t.ownerDocument.getElementById(s);if(c)return{node:c,offset:0}}for(const{index:c}of e){const o=t?$(t,n)[c]:null;if(o==="first")return{node:t.firstChild??t};if(o==="last")return{node:t.lastChild??t};if(o==="before")return{node:t,before:!0};if(o==="after")return{node:t,after:!0};t=o}const{offset:r}=e[e.length-1];if(!Array.isArray(t))return{node:t,offset:r};let i=0;for(const c of t){const{length:o}=c.nodeValue;if(i+o>=r)return{node:c,offset:r-i};i+=o}},x=(t,e,n)=>{const{parentNode:s,id:r}=t,i=$(s,n),c=i.findIndex(l=>Array.isArray(l)?l.some(u=>u===t):l===t),o=i[c];if(Array.isArray(o)){let l=0;for(const u of o)if(u===t){l+=e;break}else l+=u.nodeValue.length;e=l}const f={id:r,index:c,offset:e};return(s!==t.ownerDocument.documentElement?x(s,null,n).concat(f):[f]).filter(l=>l.index!==-1)},_=(t,e)=>{const{startContainer:n,startOffset:s,endContainer:r,endOffset:i}=t,c=x(n,s,e);if(t.collapsed)return d([c]);const o=x(r,i,e);return R([c],[o])},q=(t,e,n)=>{const s=a(e),r=a(e,!0),i=t.documentElement,c=A(i,s[0],n),o=A(i,r[0],n),f=t.createRange();return c.before?f.setStartBefore(c.node):c.after?f.setStartAfter(c.node):f.setStart(c.node,c.offset),o.before?f.setEndBefore(o.node):o.after?f.setEndAfter(o.node):f.setEnd(o.node,o.offset),f},z=t=>{const e=[],{parentNode:n}=t[0],s=x(n);for(const[r,i]of $(n).entries()){const c=t[e.length];i===c&&e.push(d([s.concat({id:c.id,index:r})]))}return e},H=(t,e)=>A(t.documentElement,a(e)).node,O={fromIndex:t=>S(`/6/${(t+1)*2}`),toIndex:t=>t?.at(-1).index/2-1},J=t=>{const[e]=p(t),n=e.shift();return e.shift(),d([[{index:6},n],e])},K=({spine_index:t,start_cfi:e,end_cfi:n})=>{const s=O.fromIndex(t)+"!";return R(s+e.slice(2),s+n.slice(2))};export{a as collapse,F as compare,O as fake,K as fromCalibreHighlight,J as fromCalibrePos,z as fromElements,_ as fromRange,E as isCFI,V as joinIndir,p as parse,H as toElement,q as toRange};
