import{c as m}from"./index-DA789M3t.js";import{b as c}from"./ebook-pfLw0BVb.js";/**
 * @license lucide-vue-next v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=m("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),i="/api/qwen";async function y(){return(await c.post(`${i}/device-auth`)).data}async function R(r){return(await c.post(`${i}/poll-token`,{session_id:r})).data}async function p(r){return(await c.post(`${i}/refresh`,{refresh_token:r})).data}async function x(r,e,t,o,n){const a=await fetch(`${i}/chat-stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r,message:e,images:o,resource_url:t})});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const l=a.body?.getReader();if(!l)throw new Error("æ— æ³•èŽ·å–å“åº”æµ");const T=new TextDecoder;let h="";try{for(;;){const{done:g,value:w}=await l.read();if(g)break;h+=T.decode(w,{stream:!0});const k=h.split(`
`);h=k.pop()||"";for(const f of k)if(f.startsWith("data: ")){const u=f.slice(6).trim();if(u==="[DONE]")return;try{const s=JSON.parse(u);if(s.content&&n&&n(s.content),s.error)throw new Error(s.error)}catch(s){if(s instanceof Error&&s.message!=="Unexpected end of JSON input")throw s}}}}finally{l.releaseLock()}}async function M(r,e,t){return(await c.post(`${i}/test`,{access_token:r,message:e,resource_url:t})).data}class d{tokenData=null;refreshTimer=null;onTokenRefreshed=null;onRefreshFailed=null;REFRESH_LEAD_TIME=10800*1e3;constructor(){this.loadFromStorage(),this.scheduleRefresh()}loadFromStorage(){try{const e=localStorage.getItem("qwen_access_token"),t=localStorage.getItem("qwen_refresh_token"),o=localStorage.getItem("qwen_expires_at"),n=localStorage.getItem("qwen_resource_url");e&&t&&o&&(this.tokenData={accessToken:e,refreshToken:t,expiresAt:parseInt(o,10),resourceUrl:n||void 0},console.log("âœ… [Token Manager] ä»Žå­˜å‚¨åŠ è½½ token",{expiresAt:new Date(this.tokenData.expiresAt).toLocaleString(),hasResourceUrl:!!n}))}catch(e){console.error("âŒ [Token Manager] åŠ è½½ token å¤±è´¥:",e)}}saveToStorage(){if(this.tokenData)try{localStorage.setItem("qwen_access_token",this.tokenData.accessToken),localStorage.setItem("qwen_refresh_token",this.tokenData.refreshToken),localStorage.setItem("qwen_expires_at",this.tokenData.expiresAt.toString()),this.tokenData.resourceUrl&&localStorage.setItem("qwen_resource_url",this.tokenData.resourceUrl),console.log("âœ… [Token Manager] Token å·²ä¿å­˜åˆ°å­˜å‚¨")}catch(e){console.error("âŒ [Token Manager] ä¿å­˜ token å¤±è´¥:",e)}}setTokens(e,t,o,n){const a=Date.now()+o*1e3;this.tokenData={accessToken:e,refreshToken:t,expiresAt:a,resourceUrl:n},this.saveToStorage(),this.scheduleRefresh(),console.log("âœ… [Token Manager] Token å·²è®¾ç½®",{expiresAt:new Date(a).toLocaleString(),expiresIn:`${Math.floor(o/60)} åˆ†é’Ÿ`})}getAccessToken(){return this.tokenData?.accessToken||null}getResourceUrl(){return this.tokenData?.resourceUrl||null}isTokenExpired(){return this.tokenData?Date.now()>=this.tokenData.expiresAt:!0}scheduleRefresh(){if(this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),!this.tokenData)return;const t=this.tokenData.expiresAt-Date.now()-this.REFRESH_LEAD_TIME;t<=0?(console.log("âš ï¸ [Token Manager] Token å³å°†è¿‡æœŸï¼Œç«‹å³åˆ·æ–°"),this.refreshTokenNow()):(console.log("â° [Token Manager] è®¡åˆ’åˆ·æ–°æ—¶é—´",{refreshIn:`${Math.floor(t/1e3/60)} åˆ†é’Ÿ`,refreshAt:new Date(Date.now()+t).toLocaleString()}),this.refreshTimer=window.setTimeout(()=>{this.refreshTokenNow()},t))}async refreshTokenNow(){if(!this.tokenData){console.warn("âš ï¸ [Token Manager] æ²¡æœ‰ token æ•°æ®ï¼Œæ— æ³•åˆ·æ–°");return}console.log("ðŸ”„ [Token Manager] å¼€å§‹åˆ·æ–° token...");try{const e=await p(this.tokenData.refreshToken);this.setTokens(e.access_token,e.refresh_token,e.expires_in,e.resource_url||this.tokenData.resourceUrl),console.log("âœ… [Token Manager] Token åˆ·æ–°æˆåŠŸ"),this.onTokenRefreshed&&this.tokenData&&this.onTokenRefreshed(this.tokenData)}catch(e){console.error("âŒ [Token Manager] Token åˆ·æ–°å¤±è´¥:",e),this.onRefreshFailed&&this.onRefreshFailed(e),console.log("â° [Token Manager] 5 åˆ†é’ŸåŽé‡è¯•åˆ·æ–°"),this.refreshTimer=window.setTimeout(()=>{this.refreshTokenNow()},300*1e3)}}onRefresh(e){this.onTokenRefreshed=e}onError(e){this.onRefreshFailed=e}clearTokens(){this.tokenData=null,this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),localStorage.removeItem("qwen_access_token"),localStorage.removeItem("qwen_refresh_token"),localStorage.removeItem("qwen_expires_at"),localStorage.removeItem("qwen_resource_url"),console.log("âœ… [Token Manager] Token å·²æ¸…é™¤")}destroy(){this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.onTokenRefreshed=null,this.onRefreshFailed=null}}const I=new d;export{S as U,x as c,R as p,I as q,p as r,y as s,M as t};
